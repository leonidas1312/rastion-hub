---
import Layout from '../layouts/Layout.astro';
import DecisionPluginCard from '../components/DecisionPluginCard.astro';
---

<Layout title="Decision Plugins | Rastion Hub" description="Community decision plugins for real optimization workflows.">
  <section class="page-head">
    <h1>Decision Plugins</h1>
    <p>Community-posted decision models you can install, adapt, and run in your local Rastion lab.</p>
  </section>

  <section class="controls">
    <div class="control-group">
      <label for="plugin-search" class="sr-only">Search decision plugins</label>
      <input id="plugin-search" type="search" placeholder="Search by name" autocomplete="off" />
    </div>
    <div class="control-group">
      <p class="pill-label">Category</p>
      <div class="category-pills" role="group" aria-label="Filter decision plugins by category">
        <button type="button" class="category-pill is-active" data-category="" aria-pressed="true">All</button>
        <button type="button" class="category-pill" data-category="Scheduling" aria-pressed="false">Scheduling</button>
        <button type="button" class="category-pill" data-category="Combinatorial" aria-pressed="false">Combinatorial</button>
        <button type="button" class="category-pill" data-category="Graph" aria-pressed="false">Graph</button>
        <button type="button" class="category-pill" data-category="Portfolio" aria-pressed="false">Portfolio</button>
        <button type="button" class="category-pill" data-category="Routing" aria-pressed="false">Routing</button>
        <button type="button" class="category-pill" data-category="General" aria-pressed="false">General</button>
      </div>
    </div>
    <p id="plugin-status" role="status" aria-live="polite">Loading decision plugins...</p>
  </section>

  <section id="plugins-grid" class="grid"></section>

  <noscript>
    <section class="grid">
      <DecisionPluginCard id={0} name="Enable JavaScript" owner={{ username: 'rastion-hub' }} />
    </section>
  </noscript>

  <script>
    import { API_URL, listDecisionPlugins, resolveDecisionPluginCategory } from '../lib/hub-api';

    const searchInput = document.getElementById('plugin-search');
    const categoryPills = Array.from(document.querySelectorAll('.category-pill'));
    const statusEl = document.getElementById('plugin-status');
    const gridEl = document.getElementById('plugins-grid');

    function clearGrid() {
      if (gridEl) {
        gridEl.innerHTML = '';
      }
    }

    function renderPluginCard(plugin) {
      const item = document.createElement('div');
      item.className = 'card-item';

      const card = document.createElement('article');
      card.className = 'plugin-card';

      const content = document.createElement('div');
      content.className = 'card-content';

      const title = document.createElement('h3');
      title.className = 'card-name';
      title.textContent = plugin.name;

      const categoryBadge = document.createElement('span');
      categoryBadge.className = 'category-badge';
      categoryBadge.textContent = resolveDecisionPluginCategory(plugin);

      const pullCommand = document.createElement('p');
      pullCommand.className = 'pull-command';
      pullCommand.textContent = `rastion plugin pull ${plugin.name}`;

      const downloadCount = document.createElement('p');
      downloadCount.className = 'download-count';
      const count = Number.isFinite(plugin.download_count) ? Number(plugin.download_count) : 0;
      downloadCount.textContent = `${count} download${count === 1 ? '' : 's'}`;

      const owner = document.createElement('p');
      owner.className = 'card-owner';
      owner.textContent = `@${plugin.owner?.username || 'unknown'}`;

      content.append(title, categoryBadge, pullCommand, downloadCount);
      card.append(content);
      item.append(card, owner);
      return item;
    }

    async function refreshPlugins() {
      if (!statusEl || !gridEl) {
        return;
      }

      const query = searchInput instanceof HTMLInputElement ? searchInput.value : '';
      const activePill = categoryPills.find((pill) => pill.classList.contains('is-active'));
      const category = activePill instanceof HTMLButtonElement ? activePill.dataset.category || '' : '';
      const categorySuffix = category ? ` in ${category}` : '';

      statusEl.textContent = 'Loading decision plugins...';
      clearGrid();

      try {
        const plugins = await listDecisionPlugins(query, category);

        if (plugins.length === 0) {
          statusEl.textContent = `No decision plugins found${categorySuffix}.`;
          return;
        }

        statusEl.textContent = `${plugins.length} decision plugin${plugins.length === 1 ? '' : 's'} found${categorySuffix}.`;

        const fragment = document.createDocumentFragment();
        for (const plugin of plugins) {
          fragment.appendChild(renderPluginCard(plugin));
        }
        gridEl.appendChild(fragment);
      } catch (error) {
        statusEl.textContent = error instanceof Error ? error.message : 'Failed to load decision plugins.';
      }
    }

    let debounceId;
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(debounceId);
        debounceId = setTimeout(() => {
          refreshPlugins();
        }, 260);
      });
    }

    for (const pill of categoryPills) {
      pill.addEventListener('click', () => {
        categoryPills.forEach((candidate) => {
          candidate.classList.remove('is-active');
          candidate.setAttribute('aria-pressed', 'false');
        });
        pill.classList.add('is-active');
        pill.setAttribute('aria-pressed', 'true');
        refreshPlugins();
      });
    }

    refreshPlugins();
  </script>

  <style>
    .page-head h1 {
      margin: 0;
      font-size: clamp(1.9rem, 5.5vw, 2.9rem);
    }

    .page-head p {
      margin: 0.35rem 0 0;
      color: var(--text-secondary);
    }

    .controls {
      margin-top: 1rem;
      margin-bottom: 0.9rem;
      display: grid;
      gap: 0.5rem;
    }

    .control-group {
      display: grid;
      gap: 0.35rem;
    }

    .control-group label {
      color: var(--text-secondary);
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    #plugin-search {
      width: min(100%, 36rem);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      font: inherit;
      padding: 0.7rem 0.8rem;
    }

    .pill-label {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .category-pills {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .category-pill {
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 0.34rem 0.75rem;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-secondary);
      font: inherit;
      font-size: 0.86rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: color 0.15s ease, border-color 0.15s ease, transform 0.15s ease, background 0.2s ease;
    }

    .category-pill:hover {
      color: var(--text-primary);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .category-pill.is-active {
      color: #ffffff;
      border-color: transparent;
      background: linear-gradient(135deg, var(--accent), var(--cyan-bright));
      box-shadow: 0 8px 16px rgba(123, 79, 242, 0.35);
    }

    #plugin-status {
      margin: 0;
      color: var(--text-secondary);
      min-height: 1.35rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    :global(.card-item) {
      display: grid;
      gap: 0.45rem;
    }

    :global(.plugin-card) {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.04), transparent 55%), var(--bg-card);
      padding: 0.85rem 0.9rem;
      min-height: 120px;
    }

    :global(.card-content) {
      display: grid;
      gap: 0.5rem;
    }

    :global(.card-name) {
      margin: 0;
      font-size: clamp(1.02rem, 1.8vw, 1.2rem);
      line-height: 1.2;
      overflow-wrap: anywhere;
    }

    :global(.category-badge) {
      width: fit-content;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 0.2rem 0.52rem;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.03);
    }

    :global(.pull-command) {
      margin: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.82rem;
      line-height: 1.35;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
      padding: 0.38rem 0.5rem;
      overflow-wrap: anywhere;
    }

    :global(.download-count) {
      margin: 0;
      font-size: 0.84rem;
      color: var(--text-secondary);
    }

    :global(.card-owner) {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</Layout>
