---
import Layout from '../layouts/Layout.astro';
import SolverCard from '../components/SolverCard.astro';
---

<Layout title="Solvers | Rastion Hub" description="Browse optimization solvers from the Rastion Hub API.">
  <section class="page-head">
    <h1>Solvers</h1>
    <p>Search and download solver packages from the hub registry.</p>
  </section>

  <section class="controls">
    <div class="control-group">
      <label for="solver-search" class="sr-only">Search solvers</label>
      <input id="solver-search" type="search" placeholder="Search by name" autocomplete="off" />
    </div>
    <div class="control-group">
      <label for="solver-category">Category</label>
      <select id="solver-category">
        <option value="">All categories</option>
        <option value="MILP">MILP</option>
        <option value="QP">QP</option>
        <option value="QUBO">QUBO</option>
        <option value="Heuristic">Heuristic</option>
        <option value="Quantum">Quantum</option>
      </select>
    </div>
    <p id="solver-status" role="status" aria-live="polite">Loading solvers...</p>
  </section>

  <section id="solvers-grid" class="grid"></section>

  <noscript>
    <section class="grid">
      <SolverCard id={0} name="Enable JavaScript" owner={{ username: 'rastion-hub' }} />
    </section>
  </noscript>

  <script>
    import { API_URL, listSolvers } from '../lib/hub-api';

    const searchInput = document.getElementById('solver-search');
    const categorySelect = document.getElementById('solver-category');
    const statusEl = document.getElementById('solver-status');
    const gridEl = document.getElementById('solvers-grid');

    function clearGrid() {
      if (gridEl) {
        gridEl.innerHTML = '';
      }
    }

    function renderSolverCard(solver) {
      const item = document.createElement('div');
      item.className = 'card-item';

      const card = document.createElement('article');
      card.className = 'solver-card';

      const content = document.createElement('div');
      content.className = 'card-content';

      const title = document.createElement('h3');
      title.className = 'card-name';
      title.textContent = solver.name;

      const categoryBadge = document.createElement('span');
      categoryBadge.className = 'category-badge';
      categoryBadge.textContent = solver.category?.trim() || 'Uncategorized';

      const download = document.createElement('a');
      download.className = 'download-btn';
      download.href = `${API_URL}/solvers/${solver.id}/download`;
      download.target = '_blank';
      download.rel = 'noreferrer';
      download.textContent = 'Download';

      const owner = document.createElement('p');
      owner.className = 'card-owner';
      owner.textContent = `@${solver.owner?.username || 'unknown'}`;

      content.append(title, categoryBadge);
      card.append(content, download);
      item.append(card, owner);
      return item;
    }

    async function refreshSolvers() {
      if (!statusEl || !gridEl) {
        return;
      }

      const query = searchInput instanceof HTMLInputElement ? searchInput.value : '';
      const category = categorySelect instanceof HTMLSelectElement ? categorySelect.value : '';
      const categorySuffix = category ? ` in ${category}` : '';

      statusEl.textContent = 'Loading solvers...';
      clearGrid();

      try {
        const solvers = await listSolvers(query, category);

        if (solvers.length === 0) {
          statusEl.textContent = `No solvers found${categorySuffix}.`;
          return;
        }

        statusEl.textContent = `${solvers.length} solver${solvers.length === 1 ? '' : 's'} found${categorySuffix}.`;

        const fragment = document.createDocumentFragment();
        for (const solver of solvers) {
          fragment.appendChild(renderSolverCard(solver));
        }
        gridEl.appendChild(fragment);
      } catch (error) {
        statusEl.textContent = error instanceof Error ? error.message : 'Failed to load solvers.';
      }
    }

    let debounceId;
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(debounceId);
        debounceId = setTimeout(() => {
          refreshSolvers();
        }, 260);
      });
    }

    if (categorySelect) {
      categorySelect.addEventListener('change', () => {
        refreshSolvers();
      });
    }

    refreshSolvers();
  </script>

  <style>
    .page-head h1 {
      margin: 0;
      font-size: clamp(1.9rem, 5.5vw, 2.9rem);
    }

    .page-head p {
      margin: 0.35rem 0 0;
      color: var(--text-secondary);
    }

    .controls {
      margin-top: 1rem;
      margin-bottom: 0.9rem;
      display: grid;
      gap: 0.5rem;
    }

    .control-group {
      display: grid;
      gap: 0.35rem;
    }

    .control-group label {
      color: var(--text-secondary);
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    #solver-search,
    #solver-category {
      width: min(100%, 36rem);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      font: inherit;
      padding: 0.7rem 0.8rem;
    }

    #solver-status {
      margin: 0;
      color: var(--text-secondary);
      min-height: 1.35rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    :global(.card-item) {
      display: grid;
      gap: 0.45rem;
    }

    :global(.solver-card) {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.04), transparent 55%), var(--bg-card);
      padding: 0.85rem 0.9rem;
      min-height: 96px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
    }

    :global(.card-content) {
      display: grid;
      gap: 0.45rem;
    }

    :global(.card-name) {
      margin: 0;
      font-size: clamp(1.02rem, 1.8vw, 1.2rem);
      line-height: 1.2;
      overflow-wrap: anywhere;
    }

    :global(.category-badge) {
      width: fit-content;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 0.2rem 0.52rem;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.03);
    }

    :global(.download-btn) {
      flex: 0 0 auto;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 0.42rem 0.75rem;
      font-size: 0.88rem;
      font-weight: 700;
      color: #241a0c;
      background: linear-gradient(135deg, var(--coral-bright), #ffd97d);
      transition: transform 0.15s ease, filter 0.15s ease;
    }

    :global(.download-btn:hover) {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    :global(.card-owner) {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</Layout>
